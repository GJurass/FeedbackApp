<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="icon" href="/static/img/LogoStarTalk 2.png" type="image/x-icon">
    <link rel="stylesheet" href="/static/stylesd.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <h1>Dashboard</h1>

        <!-- Filtro de Atendente -->
        <div class="card">
            <h3>Filtrar por Atendente</h3>
            <select id="atendente-select">
                {% for atendente in atendentes %}
                    <option value="{{ atendente }}">{{ atendente }}</option>
                {% endfor %}
            </select>
            <button id="filtrar-btn">Filtrar</button>
        </div>        

        <div class="chart-container">
            <!-- Gráfico de pizza do atendente -->
            <div class="chart">
                <canvas id="chart-atendente"></canvas>
            </div>
            <!-- Gráfico de pizza da média geral -->
            <div class="chart">
                <canvas id="chart-media-geral"></canvas>
            </div>
        </div>

        <!-- Tabela de avaliações -->
        <tbody id="tabela-avaliacoes">
            <!-- Os dados serão preenchidos dinamicamente -->
        </tbody>

        <!-- Tabela de Feedbacks -->
        <div class="card">
            <h3>Avaliações por Atendente</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Protocolo</th>
                            <th>Atendente</th>
                            <th>Nota</th>
                            <th>Comentário</th>
                            <th>Data</th>
                        </tr>
                    </thead>
                    <tbody id="tabela-avaliacoes">
                        <!-- Os dados da tabela serão preenchidos dinamicamente -->
                    </tbody>
                </table>
            </div>
        </div>        
    </div>
        
    <script>
        document.getElementById('filtrar-btn').addEventListener('click', async () => {
            const atendente = document.getElementById('atendente-select').value;

            try {
                // Requisição para os dados do atendente
                const responseAtendente = await fetch(`/get_filtered_feedback?atendente=${atendente}`);
                const dataAtendente = await responseAtendente.json();

                // Requisição para os dados da média geral
                const responseMediaGeral = await fetch(`/get_general_feedback`);
                const dataMediaGeral = await responseMediaGeral.json();

                if (responseAtendente.ok) {
                    // Atualiza o gráfico do atendente
                    const ctxAtendente = document.getElementById('chart-atendente').getContext('2d');
                    const chartAtendente = Chart.getChart(ctxAtendente);
                    if (chartAtendente) {
                        chartAtendente.destroy();
                    }

                    new Chart(ctxAtendente, {
                        type: 'pie',
                        data: {
                            labels: ['Nota 1', 'Nota 2', 'Nota 3', 'Nota 4', 'Nota 5'],
                            datasets: [{
                                label: `Distribuição de Avaliações - ${atendente}`,
                                data: dataAtendente.grafico,
                                backgroundColor: ['#E74C3C', '#F39C12', '#F1C40F', '#27AE60', '#2ECC71'],
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { display: true },
                                title: { display: true, text: `Distribuição de Notas - ${atendente}`,
                                    font:{size:30}
                                 }
                            }
                        },
                    });

                    // Atualiza a tabela com os dados do atendente
                    const tabela = document.getElementById('tabela-avaliacoes');
                    tabela.innerHTML = ''; // Limpa os dados antigos da tabela

                    dataAtendente.feedbacks.forEach(feedback => {
                        const linha = document.createElement('tr');
                        linha.innerHTML = `
                            <td>${feedback.protocolo}</td>
                            <td>${feedback.atendente}</td>
                            <td>${feedback.rating}</td>
                            <td>${feedback.comentario || '-'}</td>
                            <td>${feedback.data}</td>
                        `;
                        tabela.appendChild(linha);
                    });
                } else {
                    alert("Erro ao buscar dados do atendente.");
                }

                if (responseMediaGeral.ok) {
                    // Atualiza o gráfico da média geral
                    const ctxMediaGeral = document.getElementById('chart-media-geral').getContext('2d');
                    const chartMediaGeral = Chart.getChart(ctxMediaGeral);
                    if (chartMediaGeral) {
                        chartMediaGeral.destroy();
                    }

                    new Chart(ctxMediaGeral, {
                        type: 'pie',
                        data: {
                            labels: ['Nota 1', 'Nota 2', 'Nota 3', 'Nota 4', 'Nota 5'],
                            datasets: [{
                                label: 'Distribuição Geral de Notas',
                                data: dataMediaGeral.grafico,
                                backgroundColor: ['#E74C3C', '#F39C12', '#F1C40F', '#27AE60', '#2ECC71'],
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { display: true },
                                title: { display: true, text: 'Distribuição Geral de Notas',
                                font: {size:30}
                                 }
                            }
                        },
                    });
                } else {
                    alert("Erro ao buscar dados da média geral.");
                }
            } catch (error) {
                console.error("Erro ao buscar os dados:", error);
                alert("Erro ao buscar dados. Tente novamente.");
            }
        });

    </script>
</body>
</html>


