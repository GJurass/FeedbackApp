<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pesquisa de Satisfação</title>
    <link rel="icon" href="/static/img/LogoStarTalk 2.png" type="image/x-icon">
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
</head>
<body>
    <div class="container">

        <div class="logo">
            <img src="{{ url_for('static', filename='img/LogoStartalk 2.png') }}" alt="Logo da Empresa" class="logo-img">
        </div>

        <h1>Pesquisa de Satisfação</h1>
        <p>Atendente: <span id="atendente"></span></p>
        <p>Protocolo: <span id="protocolo"></span></p>
        
        <h3>Avalie o atendente:</h3>
        <div class="rating-container" data-group="atendente">
            <div class="circle circle-atendente-1">1</div>
            <div class="circle circle-atendente-2">2</div>
            <div class="circle circle-atendente-3">3</div>
            <div class="circle circle-atendente-4">4</div>
            <div class="circle circle-atendente-5">5</div>
        </div>
        
        <h3>Com base na sua experiência, quanto você recomendaria a StarTalk?</h3>
        <div class="rating-container" data-group="recomendacao">
            <div class="circle circle-recomendacao-1">1</div>
            <div class="circle circle-recomendacao-2">2</div>
            <div class="circle circle-recomendacao-3">3</div>
            <div class="circle circle-recomendacao-4">4</div>
            <div class="circle circle-recomendacao-5">5</div>
        </div>
        
        <h3>Comentários:</h3>
        <textarea id="comentario" placeholder="Digite seu comentário aqui..."></textarea>

        <button onclick="submitForm()">Enviar Avaliação</button>
        <p id="sucesso" style="display:none; color:green;">Sucesso! Avaliação enviada.</p>
        <p id="erro" style="display:none; color:red;">Erro ao enviar avaliação.</p>
    </div>

    <script>
    // Variáveis de controle
    const protocolo = "2024121700125";
    const atendente = "Marcos";
    let ratings = {
        atendente: 0,
        recomendacao: 0,
    };

    // Exibir protocolo e atendente
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById("protocolo").innerText = protocolo;
        document.getElementById("atendente").innerText = atendente;

        // Seleção de nota
        const ratingContainers = document.querySelectorAll('.rating-container');

        ratingContainers.forEach(container => {
            const group = container.dataset.group; // Identifica o grupo (atendente/recomendacao)
            const buttons = container.querySelectorAll('.circle');

            buttons.forEach(button => {
                button.addEventListener('click', () => {
                    // Remove a classe 'active' e redefine o estilo para padrão do grupo atual
                    buttons.forEach(btn => {
                        btn.classList.remove('active');
                        btn.style.backgroundColor = '#fff'; // Reseta o fundo para branco
                        btn.style.color = window.getComputedStyle(btn).borderColor; // Reseta a cor do texto para a borda
                    });

                    // Adiciona a classe 'active' ao botão clicado
                    button.classList.add('active');

                    // Altera o fundo para a cor da borda do botão clicado
                    const borderColor = window.getComputedStyle(button).borderColor;
                    button.style.backgroundColor = borderColor;

                    // Altera a cor do texto do botão clicado para branco
                    button.style.color = '#fff';

                    // Atualiza o valor da nota selecionada
                    ratings[group] = parseInt(button.textContent);
                });
            });
        });

        // Vincular evento de clique ao botão de envio
        const submitButton = document.querySelector('button');
        submitButton.addEventListener('click', submitForm);
    });

    // Função para enviar o formulário
        let isSubmitting = false; // Variável para controlar o envio

    async function submitForm() {
        const comentario = document.getElementById("comentario").value;
        const submitButton = document.querySelector('button'); // Seleciona o botão

        // Verifica se já está enviando
        if (isSubmitting) return;

        // Marca como enviando
        isSubmitting = true;

        // Desativa o botão para evitar cliques repetidos
        submitButton.disabled = true;

        // Verificação básica antes do envio
        if (!ratings.atendente || !ratings.recomendacao) {
            alert("Selecione uma nota para cada pergunta antes de enviar.");
            submitButton.disabled = false; // Reativa o botão em caso de erro
            isSubmitting = false; // Libera para novo envio
            return;
        }

        // Envia os dados via POST
        try {
            const response = await fetch('/submit_feedback', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    protocolo,
                    atendente,
                    rating_atendente: ratings.atendente,
                    rating_recomendacao: ratings.recomendacao,
                    comentario,
                }),
            });

            if (response.ok) {
                const result = await response.json();
                window.location.href = result.redirect; // Redireciona após o envio
            } else {
                alert("Erro ao enviar avaliação. Tente novamente.");
                submitButton.disabled = false; // Reativa o botão em caso de erro
                isSubmitting = false; // Libera para novo envio
            }
        } catch (error) {
            alert("Ocorreu um erro inesperado. Por favor, tente novamente.");
            console.error(error);
            submitButton.disabled = false; // Reativa o botão em caso de erro
            isSubmitting = false; // Libera para novo envio
        }
    }

    // Garante que o evento é registrado apenas uma vez
    document.addEventListener('DOMContentLoaded', () => {
        const submitButton = document.querySelector('button');
        submitButton.addEventListener('click', submitForm, { once: true });
    });
    </script>
</body>
</html>
